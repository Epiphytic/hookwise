name: Semantic Release

on:
  push:
    branches: [main]

concurrency:
  group: release
  cancel-in-progress: false

permissions:
  contents: write
  id-token: write

jobs:
  semantic-release:
    name: Semantic Release
    runs-on: ubuntu-latest
    if: "!contains(github.event.head_commit.message, '[skip ci]')"
    outputs:
      new_release_published: ${{ steps.release.outputs.new_release_published }}
      new_release_version: ${{ steps.release.outputs.new_release_version }}
    steps:
      - uses: actions/checkout@v4
        with:
          persist-credentials: false

      - name: Setup Node.js 22
        uses: actions/setup-node@v4
        with:
          node-version: "22"

      - name: Install stable Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Make update-version.sh executable
        run: chmod +x scripts/update-version.sh

      - name: Install semantic-release plugins
        run: npm install --no-save semantic-release @semantic-release/exec @semantic-release/git @semantic-release/github

      - name: Run semantic-release
        id: release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}
        run: npx semantic-release

  update-marketplace:
    name: Update plugin-marketplace
    needs: semantic-release
    if: needs.semantic-release.outputs.new_release_published == 'true'
    runs-on: ubuntu-latest
    permissions:
      id-token: write
    steps:
      - name: Get OIDC token
        id: oidc
        run: |
          OIDC_TOKEN=$(curl -sS -H "Authorization: bearer ${ACTIONS_ID_TOKEN_REQUEST_TOKEN}" \
            "${ACTIONS_ID_TOKEN_REQUEST_URL}&audience=sts.epiphytic.org" | jq -r '.value')
          echo "::add-mask::${OIDC_TOKEN}"
          echo "oidc_token=${OIDC_TOKEN}" >> "$GITHUB_OUTPUT"

      - name: Exchange for GitHub token via STS
        id: sts
        env:
          OIDC_TOKEN: ${{ steps.oidc.outputs.oidc_token }}
        run: |
          RESPONSE=$(curl -s -w "\n%{http_code}" \
            -X POST \
            -H "Authorization: Bearer ${OIDC_TOKEN}" \
            -H "Content-Type: application/json" \
            "https://sts.epiphytic.org/sts/exchange?scope=Epiphytic/.github&identity=hookwise-release")

          HTTP_CODE=$(echo "$RESPONSE" | tail -1)
          BODY=$(echo "$RESPONSE" | head -n -1)

          if [ "$HTTP_CODE" != "200" ]; then
            echo "STS exchange failed with HTTP ${HTTP_CODE}: ${BODY}"
            exit 1
          fi

          GH_TOKEN=$(echo "$BODY" | jq -r '.access_token')
          echo "::add-mask::${GH_TOKEN}"
          echo "gh_token=${GH_TOKEN}" >> "$GITHUB_OUTPUT"

      - name: Update marketplace version
        env:
          GH_TOKEN: ${{ steps.sts.outputs.gh_token }}
          NEW_VERSION: ${{ needs.semantic-release.outputs.new_release_version }}
        run: |
          # Fetch current marketplace.json from plugin-marketplace
          RESPONSE=$(curl -sS -H "Authorization: token ${GH_TOKEN}" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/Epiphytic/plugin-marketplace/contents/marketplace.json")

          CURRENT_SHA=$(echo "$RESPONSE" | jq -r '.sha')
          CONTENT=$(echo "$RESPONSE" | jq -r '.content' | base64 -d)

          # Update hookwise version using jq
          UPDATED=$(echo "$CONTENT" | jq --arg v "$NEW_VERSION" '
            .plugins |= map(
              if .name == "hookwise" then .version = $v else . end
            )
          ')

          # Encode and push
          ENCODED=$(echo "$UPDATED" | base64 -w 0)

          curl -sS -X PUT \
            -H "Authorization: token ${GH_TOKEN}" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/Epiphytic/plugin-marketplace/contents/marketplace.json" \
            -d '{
              "message": "chore: update hookwise to v'"${NEW_VERSION}"'",
              "content": "'"${ENCODED}"'",
              "sha": "'"${CURRENT_SHA}"'"
            }'

          echo "Updated plugin-marketplace to hookwise v${NEW_VERSION}"
